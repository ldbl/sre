# Flux Installation & Bootstrap

Flux powers the GitOps control plane. Terraform provisions the controllers using the `tehcyx/kind` cluster module under `infra/terraform/kind_cluster/` and deploys the Flux Operator (`flux-operator`) plus a Flux instance (`flux-instance`) via the Helm provider.

## Prerequisites
- Local kind cluster managed by Terraform (see `docs/local-dev.md`).
- Helm provider requirements satisfied (Terraform automatically leverages the kubeconfig generated by the kind module).
- `kubectl` for verification and optional Flux CLI if you want to run `flux` commands.

## Install Flux Controllers
Flux is installed automatically during `terraform apply`:
```bash
cd infra/terraform/kind_cluster
terraform init
terraform apply
```
Terraform will:
1. Create/update the kind cluster and merge the kubeconfig into `~/.kube/config`.
2. Deploy the Flux Operator Helm chart (`oci://ghcr.io/controlplaneio-fluxcd/charts/flux-operator`).
3. Deploy a Flux instance via the `flux-instance` chart with controllers for image automation and cluster-wide reconciliation.

To enable GitOps reconciliation of this repository, set the following environment variables (or add to your Terraform variables file) before running `terraform apply`:
```bash
export TF_VAR_flux_git_repository_url="https://github.com/ldbl/sre.git"
export TF_VAR_flux_git_repository_branch="main"
export TF_VAR_flux_kustomization_path="./infra/kubernetes/clusters/sre"
```
Terraform will create a `GitRepository` and `Kustomization` in `flux-system` pointing to the specified path. Adjust the URL/path to match your desired GitOps layout.

## Verify Installation
```bash
kubectl --context sre-control-plane -n flux-system get pods
# Optional, if flux CLI installed
flux check --context sre-control-plane
```
Controllers may take up to a minute to settle in a fresh kind cluster.

## Apply GitOps Sources
After Flux components are running, declare GitRepository/Kustomization resources under `infra/kubernetes/` (examples forthcoming) and let Flux reconcile them.

## Uninstall
`terraform destroy` tears down the kind cluster and automatically removes both Helm releases, cleaning up the `flux-system` namespace.

To upgrade Flux components, bump the `version` fields of `helm_release.flux_operator` and `helm_release.flux_instance` in `infra/terraform/kind_cluster/main.tf`, then re-run `terraform apply`.
