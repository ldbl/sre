# Flux Installation & Bootstrap

Flux powers the GitOps control plane. Terraform provisions controllers under `infra/terraform/kind_cluster/` by applying Flux Operator manifests and creating a `FluxInstance` resource.

## Prerequisites
- Local kind cluster managed by Terraform (see `docs/local-dev.md`).
- Helm provider requirements satisfied (Terraform automatically leverages the kubeconfig generated by the kind module).
- `kubectl` for verification and optional Flux CLI if you want to run `flux` commands.

## Install Flux Controllers
Flux is installed automatically during `terraform apply`:
```bash
cd infra/terraform/kind_cluster
terraform init
terraform apply
```
Terraform will:
1. Create/update the kind cluster and merge the kubeconfig into `~/.kube/config`.
2. Install Flux Operator from upstream manifests.
3. Create a `FluxInstance` with source/kustomize/helm/notification/image controllers enabled.

To enable GitOps reconciliation of this repository, set the following environment variables (or add to your Terraform variables file) before running `terraform apply`:
```bash
export TF_VAR_flux_git_repository_url="https://github.com/ldbl/sre.git"
export TF_VAR_flux_git_repository_branch="main"
export TF_VAR_flux_kustomization_path="./flux/bootstrap/flux-system"
```
Terraform will create a `GitRepository` and `Kustomization` in `flux-system` pointing to the specified path. Adjust the URL/path to match your desired GitOps layout.
Terraform sets the `sync` block on `FluxInstance`; Flux then manages `GitRepository`/`Kustomization` resources in-cluster.

## Verify Installation
```bash
kubectl --context sre-control-plane -n flux-system get pods
# Optional, if flux CLI installed
flux check --context sre-control-plane
```
Controllers may take up to a minute to settle in a fresh kind cluster.

## Apply GitOps Sources
After Flux components are running, declare GitRepository/Kustomization resources under `flux/` and let Flux reconcile them.

## Uninstall
`terraform destroy` tears down the kind cluster and removes the `FluxInstance` resource as part of Terraform cleanup.

To upgrade Flux components, update `var.flux_version` in `infra/terraform/kind_cluster/variables.tf` (or via `TF_VAR_flux_version`) and re-run `terraform apply`.
