---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: observability
spec:
  interval: 30m
  chart:
    spec:
      chart: kube-prometheus-stack
      version: ">=65.0.0 <66.0.0"
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: observability
      interval: 12h
  values:
    # Prometheus configuration
    prometheus:
      prometheusSpec:
        retention: 7d
        retentionSize: "10GB"
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 2Gi
        storageSpec:
          volumeClaimTemplate:
            spec:
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 10Gi
        # Enable service monitor discovery across all namespaces
        serviceMonitorSelector: {}
        serviceMonitorNamespaceSelector: {}
        podMonitorSelector: {}
        podMonitorNamespaceSelector: {}

    # Grafana configuration
    grafana:
      enabled: true
      adminPassword: admin
      persistence:
        enabled: true
        size: 5Gi
      resources:
        requests:
          cpu: 25m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
      # Default dashboards
      defaultDashboardsEnabled: true
      defaultDashboardsTimezone: UTC
      # Ingress for Grafana
      ingress:
        enabled: true
        ingressClassName: nginx
        hosts:
          - grafana.local
        path: /
        pathType: Prefix
      # Additional data sources
      additionalDataSources:
        - name: Loki
          type: loki
          access: proxy
          url: http://loki-gateway.observability.svc.cluster.local
          jsonData:
            maxLines: 1000
          editable: false

    # Alertmanager configuration
    alertmanager:
      enabled: true
      alertmanagerSpec:
        retention: 120h
        storage:
          volumeClaimTemplate:
            spec:
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 5Gi
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
      config:
        global:
          resolve_timeout: 5m
        route:
          group_by: ['alertname', 'cluster', 'service']
          group_wait: 10s
          group_interval: 10s
          repeat_interval: 12h
          receiver: 'default'
          routes:
            - match:
                alertname: Watchdog
              receiver: 'null'
            - match:
                severity: critical
              receiver: 'critical'
              continue: true
            - match:
                severity: warning
              receiver: 'warning'
        receivers:
          - name: 'null'
          - name: 'default'
            # Add your notification integrations here (Slack, email, etc.)
          - name: 'warning'
            # Warning notifications
          - name: 'critical'
            # Critical notifications

    # Prometheus Operator configuration
    prometheusOperator:
      resources:
        requests:
          cpu: 25m
          memory: 100Mi
        limits:
          cpu: 500m
          memory: 256Mi

    # Node exporter - collect node metrics
    nodeExporter:
      enabled: true

    # Kube-state-metrics - collect Kubernetes object metrics
    kubeStateMetrics:
      enabled: true

    # Additional scrape configs
    prometheus-node-exporter:
      resources:
        requests:
          cpu: 10m
          memory: 32Mi
        limits:
          cpu: 200m
          memory: 128Mi
