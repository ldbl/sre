name: Frontend - Promote to Production

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub release with commit SHA'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/frontend

jobs:
  promote:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata from staging image
        id: build_meta
        run: |
          echo "Inspecting staging image for metadata..."

          LABELS=$(docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging --format '{{ json .Manifest.Config.Labels }}' 2>/dev/null || echo "{}")

          if [ "$LABELS" = "{}" ] || [ -z "$LABELS" ]; then
            echo "Trying alternative inspection method..."
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging --platform linux/amd64
            LABELS=$(docker inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging --format '{{ json .Config.Labels }}')
          fi

          echo "Labels found: $LABELS"

          VERSION=$(echo "$LABELS" | jq -r '."org.opencontainers.image.version" // empty')
          FULL_SHA=$(echo "$LABELS" | jq -r '."org.opencontainers.image.revision" // empty')

          if [ -z "$FULL_SHA" ]; then
            FULL_SHA=$(git rev-parse HEAD)
          fi

          SHORT_SHA=$(echo "$FULL_SHA" | cut -c1-7)

          if [ -z "$VERSION" ]; then
            VERSION="v0.0.0"
          fi

          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

          echo "Promoting staging image:"
          echo "  Version: ${VERSION}"
          echo "  Short SHA: ${SHORT_SHA}"

      - name: Promote staging to production (multi-platform)
        run: |
          TIMESTAMP=$(date +%s)

          docker buildx imagetools create \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:production \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:production-${{ steps.build_meta.outputs.version }}-${{ steps.build_meta.outputs.short_sha }}-${TIMESTAMP} \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging

          echo "Promoted image to production"
          echo "Created tags: production, production-${{ steps.build_meta.outputs.version }}-${{ steps.build_meta.outputs.short_sha }}-${TIMESTAMP}"

